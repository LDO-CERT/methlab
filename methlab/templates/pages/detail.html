{% extends "base.html" %}
{% load static i18n leaflet_tags %}
{% block extra_css %}
<script src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/jsoneditor/9.0.3/jsoneditor.css" rel="stylesheet" type="text/css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsoneditor/9.0.3/jsoneditor.min.js"></script>
{% leaflet_js %}
{% leaflet_css %}
{% endblock extra_css %}

{% block container%}
<section class="py-5 container">
  <div class="row py-lg-5">
    <div class="col">

      <ul class="nav nav-pills" role="tablist">
        <li class="nav-item" role="presentation">
          <a class="nav-link active" id="info-tab" data-toggle="tab" href="#info" role="tab" aria-controls="info"
            aria-selected="true">Mail Info</a>
        </li>
        {% if mail.header %}
        <li class="nav-item" role="presentation">
          <a class="nav-link" id="header-tab" data-toggle="tab" href="#header" role="tab" aria-controls="header"
            aria-selected="false">Header</a>
        </li>
        {% endif %}
        <li class="nav-item" role="presentation">
          <a class="nav-link" id="body-tab" data-toggle="tab" href="#body" role="tab" aria-controls="body"
            aria-selected="true">Body</a>
        </li>
        {% if mail.received %}
        <li class="nav-item" role="presentation">
          <a class="nav-link" id="received-tab" data-toggle="tab" href="#received" role="tab" aria-controls="received"
            aria-selected="false">Received</a>
        </li>
        {% endif %}
        <li class="nav-item" role="presentation">
          <a class="nav-link" id="addresses-tab" data-toggle="tab" href="#addresses" role="tab"
            aria-controls="addresses" aria-selected="false">Addresses</a>
        </li>
        {% if mail.geom %}
        <li class="nav-item" role="presentation">
          <a class="nav-link" id="location-tab" data-toggle="tab" href="#location" role="tab" aria-controls="location"
            aria-selected="false">Location</a>
        </li>
        {% endif %}
        {% if mail.iocs.all %}
        <li class="nav-item" role="presentation">
          <a class="nav-link" id="iocs-tab" data-toggle="tab" href="#iocs" role="tab" aria-controls="iocs"
            aria-selected="false">Iocs</a>
        </li>
        {% endif %}
        {% if mail.attachments.all %}
        <li class="nav-item" role="presentation">
          <a class="nav-link" id="attachments-tab" data-toggle="tab" href="#attachments" role="tab"
            aria-controls="attachments" aria-selected="false">Attachments</a>
        </li>
        {% endif %}
      </ul>

      <div class="tab-content">

        <!--- INFO -->
        <div class="tab-pane fade show active" id="info" role="tabpanel" aria-labelledby="info-tab">
          <div style="padding: 20px;">
            <dl class="row">
              <dt class="col-sm-3">Subject:</dt>
              <dd class="col-sm-9">{{mail.subject}}</dd>
              <dt class="col-sm-3">Message-id:</dt>
              <dd class="col-sm-9">{{mail.message_id}}</dd>
              <dt class="col-sm-3">Date:</dt>
              <dd class="col-sm-9">{{mail.date}}</dd>
              <dt class="col-sm-3">Submission Date:</dt>
              <dd class="col-sm-9">{{mail.submission_date}}</dd>
              <dt class="col-sm-3">Assignee:</dt>
              <dd class="col-sm-9">
                <select class="form-control" id="change-assignee">
                  <option {% if not mail.assignee %}selected='selected' {% endif %}>--</option>
                  {% for user in users %}
                  <option {% if user == mail.assignee %}selected='selected' {% endif %}>{{user}}</option>
                  {% endfor %}
                </select>
              </dd>
              <hr />
              {% if mail.dmark or mail.dkim %}
              {% if mail.dmark %}
              <dt class="col-sm-3">Dmark:</dt>
              <dd class="col-sm-9">{{mail.dmark}}</dd>
              {% endif %}
              {% if mail.dkim %}
              <dt class="col-sm-3">Dkim Check:</dt>
              <dd class="col-sm-9">{{mail.dkim}}</dd>
              {% endif %}
              <hr />
              {% endif %}
              <dt class="col-sm-3">Tags:</dt>
              <dd class="col-sm-9">
                {% if mail.tags.all %}
                {% for tag in mail.tags.all %}
                <span class="badge" style="background-color: {{tag.color}};">{{tag}}</span>
                {% endfor %}
                {% endif %}
                <button class="btn btn-sm btn-success" id="add_tag">+</button>
              </dd>
              <hr />
              <dt class="col-sm-3">Response:</dt>
              <dd class="col-sm-9">
                <select class="form-control" id="change-response">
                  {% for response in responses %}
                  <option {% if mail.official_response == response %}selected='selected' {% endif %}>{{response}}
                  </option>
                  {% endfor %}
                </select>
              </dd>
            </dl>
          </div>
        </div>

        <!--- RECEIVED -->
        {% if mail.received %}
        <div class="tab-pane fade show" id="received" role="tabpanel" aria-labelledby="received-tab">
          <div style="padding: 20px;">
            <div id="js_received" style="width: 100%; height: 400px;"></div>
          </div>
        </div>
        {% endif %}

        <!--- HEADER -->
        {% if mail.header %}
        <div class="tab-pane fade show" id="header" role="tabpanel" aria-labelledby="header-tab">
          <div style="padding: 20px;">
            <div id="js_header" style="width: 100%; height: 400px;"></div>
          </div>
        </div>
        {% endif %}

        <!--- BODY -->
        <div class="tab-pane fade show" id="body" role="tabpanel" aria-labelledby="body-tab">
          <div style="padding: 20px;">
            <dl class="row">
              <p class="col-sm-12">{{mail.body}}</p>
            </dl>
          </div>
        </div>

        <!-- ADDRESSES -->
        <div class="tab-pane fade show" id="addresses" role="tabpanel" aria-labelledby="addresses-tab">
          <div style="padding: 20px;">
            <dl class="row">
              <dt class="col-sm-3">From:</dt>
              <dd class="col-sm-9">
                {% for address in mail.mail_addresses_set.all %}
                {% if address.field == 'from' %}
                {{address.address.address}}
                <button class="btn btn-sm btn-success" data-pk="{{address.pk}}" data-type="address">+</button>
                <br />
                [{{address.address.name|join:","}}]
                {% endif %}
                {% endfor%}
              </dd>
              <dt class="col-sm-3">MX:</dt>
              <dd class="col-sm-9">
                {% for address in mail.mail_addresses_set.all %}
                {% if address.field == 'from' %}
                {{address.address.mx_check}}
                {% endif %}
                {% endfor%}
              </dd>
              <hr />
              <dt class="col-sm-3">To:</dt>
              <dd class="col-sm-9">
                {% for address in mail.mail_addresses_set.all %}
                {% if address.field == 'to' %}
                {{address.address.address}}
                <button class="btn btn-sm btn-success" data-pk="{{address.pk}}" data-type="address">+</button>
                <br />
                [{{address.address.name|join:","}}]
                {% endif %}
                {% endfor%}
              </dd>
              <hr />
              <dt class="col-sm-3">Cc:</dt>
              <dd class="col-sm-9">
                {% for address in mail.mail_addresses_set.all %}
                {% if address.field == 'cc' %}
                {{address.address.address}}
                <button class="btn btn-sm btn-success" data-pk="{{address.pk}}" data-type="address">+</button>
                <br />
                [{{address.address.name|join:","}}]
                {% endif %}
                {% endfor%}
              </dd>
              <dt class="col-sm-3">Bcc:</dt>
              <dd class="col-sm-9">
                {% for address in mail.mail_addresses_set.all %}
                {% if address.field == 'bcc' %}
                {{address.address.address}}
                <button class="btn btn-sm btn-success" data-pk="{{address.pk}}" data-type="address">+</button>
                <br />
                [{{address.address.name|join:","}}]
                {% endif %}
                {% endfor%}
              </dd>
              <hr />
              <dt class="col-sm-3">Reply to:</dt>
              <dd class="col-sm-9">
                {% for address in mail.mail_addresses_set.all %}
                {% if address.field == 'reply_to' %}
                {{address.address.address}}
                <button class="btn btn-sm btn-success" data-pk="{{address.pk}}" data-type="address">+</button>
                <br />
                [{{address.address.name|join:","}}]
                {% endif %}
                {% endfor%}
              </dd>
              {% if mail.to_domains%}
              <hr />
              <dt class="col-sm-3">To-domains:</dt>
              <dd class="col-sm-9">{{mail.to_domains|join:"<br>"}}</dd>
              {% endif %}
              {% if mail.sender_ip_address%}
              <hr />
              <dt class="col-sm-3">Sender IP address:</dt>
              <dd class="col-sm-9">{{mail.sender_ip_address}}</dd>
              {% endif %}
            </dl>
          </div>
        </div>

        <!--- MAP -->
        {% if mail.geom %}
        <div class="tab-pane fade show" id="location" role="tabpanel" aria-labelledby="location-tab">
          <div style="padding: 20px;">
            <div>{% leaflet_map "main" callback="main_map_init" %}</div>
          </div>
        </div>
        {% endif %}

        <!--- IOCS -->
        {% if mail.iocs.all %}
        <div class="tab-pane fade show" id="iocs" role="tabpanel" aria-labelledby="iocs-tab">
          <div style="padding: 20px;">
            <table class="table">
              <thead>
                <tr>
                  <td>Ioc</td>
                  <td>Whois</td>
                  <td>Report</td>
                  <td>Whitelist</td>
                </tr>
              </thead>
              <tbody>
                {% for ioc in mail.iocs.all %}
                <tr>
                  <td>
                    {% if ioc.is_whitelisted %}
                    <span class="badge bg-success">
                      {% endif %}
                      {{ioc}}
                      {% if ioc.is_whitelisted %}
                    </span>
                    {% endif %}
                  </td>
                  <td>
                    {% if ioc.is_whitelisted %}
                    -
                    {% else %}
                    {% if ioc.whois.name and ioc.whois.status %}
                    <dl class="row">
                      <dt class="col-sm-3">Name:</dt>
                      <dd class="col-sm-9">{{ioc.whois.name}}</dd>
                      <dt class="col-sm-3">Name Servers:</dt>
                      <dd class="col-sm-9">{{ioc.whois.name_servers|join:", "}}</dd>
                      <dt class="col-sm-3">Status:</dt>
                      <dd class="col-sm-9">{{ioc.whois.status}}</dd>
                      <dt class="col-sm-3">Registrar:</dt>
                      <dd class="col-sm-9">{{ioc.whois.registrar}}</dd>
                      <dt class="col-sm-3">Creation Date:</dt>
                      <dd class="col-sm-9">{{ioc.whois.creation_date}}</dd>
                      <dt class="col-sm-3">Expiration Date:</dt>
                      <dd class="col-sm-9">{{ioc.whois.expiration_date}}</dd>
                    </dl>
                    {% elif not ioc.whois %}
                    -
                    {% else %}
                    {{ioc.whois}}
                    {% endif %}
                    {% endif %}
                  </td>
                  <td>
                    {% if ioc.is_whitelisted %}
                    -
                    {% else %}
                    {% if ioc.reports.all %}
                    <dl class="row">
                      {% for report in ioc.reports.all %}
                      <dt class="col-sm-3">{{report.analyzer.name}}</dt>
                      <dd class="col-sm-9">{{report.taxonomies}}</dd>
                      {% endfor %}
                    </dl>
                    {% else %}
                    -
                    {% endif %}
                    {% endif %}
                  </td>
                  <td>
                    {% if ioc.is_whitelisted %}
                    <button class="btn btn-sm btn-danger" data-pk="{{ioc.pk}}" data-type="ioc">-</button>
                    {% else %}
                    <button class="btn btn-sm btn-success" data-pk="{{ioc.pk}}" data-type="ioc">+</button>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        {% endif %}

        <!--- ATTACHMENTS -->
        {% if mail.attachments.all %}
        <div class="tab-pane fade show" id="attachments" role="tabpanel" aria-labelledby="attachments-tab">
          <div style="padding: 20px;">
            <table class="table">
              <thead>
                <tr>
                  <td>Info</td>
                  <td>Report</td>
                  <td>Whitelist</td>
                </tr>
              </thead>
              <tbody>
                {% for attachment in mail.attachments.all %}
                <tr>
                  <td>
                    <dl class="row">
                      <dt class="col-sm-3">Filenames</dt>
                      <dd class="col-sm-9">{{attachment.filename|join:"<br/>"}}</dd>
                      <dt class="col-sm-3">md5</dt>
                      <dd class="col-sm-9">{{attachment.md5}}</dd>
                      <dt class="col-sm-3">sha256</dt>
                      <dd class="col-sm-9">{{attachment.sha256}}</dd>
                    </dl>
                  </td>
                  <td>
                    {% if attachment.reports.all %}
                    <dl class="row">
                      {% for report in attachment.reports.all %}
                      <dt class="col-sm-3">{{report.analyzer.name}}</dt>
                      <dd class="col-sm-9">{{report.taxonomies}}</dd>
                      {% endfor %}
                    </dl>
                    {% else %}
                    -
                    {% endif %}
                  </td>
                  <td>
                    {% if attachment.is_whitelisted %}
                    <button class="btn btn-sm btn-danger" data-pk="{{attachment.pk}}" data-type="attachment">-</button>
                    {% else %}
                    <button class="btn btn-sm btn-success" data-pk="{{attachment.pk}}" data-type="attachment">+</button>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <script>
    const options = {
      mode: 'code',
      modes: ['text', 'code', 'view'],
      onEditable: function (node) {
        if (!node.path) { return false; }
      }
    }
    {% if mail.received %}
    const received_cont = document.getElementById("js_received")
    const received_editor = new JSONEditor(received_cont, options)
    received_editor.set({{ mail.received | safe }})
    {% endif %}
    {% if mail.header %}
    const header_cont = document.getElementById("js_header")
    const header_editor = new JSONEditor(header_cont, options)
    header_editor.set({{ mail.header | safe }})
    {% endif %}
    {% if mail.geom %}
    function main_map_init(map, options) {
      L.geoJson({{ mail.geom | safe }}).addTo(map);
        }
    {% endif %}

    $(document).on('click', '#add_tag', function () {
      bootbox.prompt("Add tag to mail!", function (result) {
        console.log(result);
      });
    });
  </script>

</section>
{% endblock container %}